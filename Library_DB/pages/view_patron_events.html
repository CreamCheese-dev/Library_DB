<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Patron Events</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Header with navigation -->
    <header>
        <h1>Patron Events</h1>
        <nav>
            <a href="../index.html">Home</a>
            <a href="browse_books.html">Books</a>
            <a href="view_book_transactions.html">Book Transactions</a>
            <a href="browse_patrons.html">Patrons</a>
            <a href="view_patron_events.html">Patron Events</a>
            <a href="view_patron_attendance.html">Patron Attendance</a>
            <a href="view_staff.html">Staff</a>
        </nav>
    </header>

    <!-- Table to display events -->
    <table id="eventsTable">
        <thead>
            <tr>
                <th>Event ID</th>
                <th>Event Name</th>
                <th>Event Date</th>
                <th>Description</th>
                <th>Attendance</th>
                <th>Staff</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Dynamic event rows will be inserted here by JavaScript -->
        </tbody>
    </table>

    <!-- Form to add a new event -->
    <h2>Add New Event</h2>
    <form id="addEventForm">
        <fieldset>
            <legend>Add New Event</legend>
            <label for="eventName">Event Name:</label><br>
            <input type="text" id="eventName" name="eventName" required><br>
            <label for="eventDate">Event Date:</label><br>
            <input type="datetime-local" id="eventDate" name="eventDate" required><br>
            <label for="description">Description:</label><br>
            <textarea id="description" name="description"></textarea><br>
            <label for="attendance">Attendance:</label><br>
            <input type="number" id="attendance" name="attendance"><br>
            <label for="staffId">Staff:</label><br>
            <select id="staffId" name="staffId" required></select><br>
            <button type="button" onclick="addEvent()">Submit</button>
        </fieldset>
    </form>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            fetchEvents();
            fetchStaff();
        });

        function fetchEvents() {
            fetch('http://read-renaissance.com/api/events')
                .then(response => response.json())
                .then(data => populateTable(data))
                .catch(error => console.error('Error fetching events:', error));
        }

        function fetchStaff() {
            fetch('http://read-renaissance.com/api/staff')
                .then(response => response.json())
                .then(staffMembers => {
                    const staffSelect = document.getElementById('staffId');
                    staffSelect.innerHTML = '';
                    staffMembers.forEach(staff => {
                        const option = document.createElement('option');
                        option.value = staff.staffId;
                        option.text = `${staff.firstName} ${staff.lastName}`;
                        staffSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching staff:', error));
        }

        function populateTable(events) {
            const tableBody = document.getElementById('eventsTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            events.forEach(event => {
                const eventDate = new Date(event.event_Date).toLocaleString();
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${event.eventID}</td>
                    <td>${event.eventName}</td>
                    <td>${eventDate}</td>
                    <td>${event.description}</td>
                    <td>${event.attendance}</td>
                    <td>${event.staffID}</td>
                    <td>
                        <button onclick="window.location.href='edit_pages/edit_patron_event.html?eventId=${event.eventID}'">Edit</button>
                        <button onclick="deleteEvent('${event.eventID}')">Delete</button>
                    </td>
                `;
            });
        }

        function addEvent() {
            const form = document.getElementById('addEventForm');
            const eventName = form.eventName.value.trim();
            const eventDate = form.eventDate.value;
            const description = form.description.value.trim();
            const attendance = parseInt(form.attendance.value, 10);
            const staffIdElement = document.getElementById('staffId');
            const staffID = parseInt(staffIdElement.value, 10);  // Ensure staffID is an integer

            if (!eventName || !eventDate || !description || isNaN(attendance) || !staffID) {
                alert('Please fill all fields correctly and ensure a staff member is selected.');
                return;
            }

            const eventData = {
                eventName,
                event_Date: eventDate,
                description,
                attendance,
                staffID
            };

            fetch('http://read-renaissance.com/api/events', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(eventData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    fetchEvents(); // Refresh the events list
                    form.reset(); // Reset form after submission
                } else {
                    throw new Error(data.error || 'Unknown error during event creation');
                }
            })
            .catch(error => {
                alert('Error adding event: ' + error.message);
                console.error('Error adding event:', error);
            });
        }

        function deleteEvent(eventId) {
            fetch(`http://read-renaissance.com/api/events/${eventId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                fetchEvents();  // Refresh the events list
            })
            .catch(error => {
                alert('Error deleting event: ' + error.message);
                console.error('Error deleting event:', error);
            });
        }
    </script>

</body>
</html>
