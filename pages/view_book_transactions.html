<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Book Transactions</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Header with navigation -->
    <header>
        <h1>Book Transactions</h1>
        <nav>
            <a href="../index.html">Home</a>
            <a href="browse_books.html">Books</a>
            <a href="view_book_transactions.html">Book Transactions</a>
            <a href="browse_patrons.html">Patrons</a>
            <a href="view_patron_events.html">Patron Events</a>
            <a href="view_patron_attendance.html">Patrons Attendance</a>
            <a href="view_staff.html">Staff</a>
        </nav>
    </header>

    <!-- Search functionality for transactions -->
    <h2>Search Transactions</h2>
    <div class="filter-container">
        <input type="text" id="filterInput" onkeyup="filterTable('transactionsTable')" placeholder="Search for transactions...">
    </div>

    <!-- Display table for book transactions -->
    <table id="transactionsTable">
        <thead>
            <tr>
                <th>Transaction ID</th>
                <th>Patron ID</th>
                <th>Number of Books</th>
                <th>Staff ID</th>
                <th>Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Dynamic content generated by JavaScript -->
        </tbody>
    </table>

    <!-- Forms for transaction management -->
    <div class="form-container">
        <!-- Form to add a new transaction -->
        <form id="addTransactionForm">
            <fieldset>
                <legend>Add New Transaction</legend>
                <label for="patronID">Patron ID (Required):</label><br>
                <select id="patronID" name="patronID" required></select><br>
                <label for="numberBooks">Number of Books (Required):</label><br>
                <input type="number" id="numberBooks" name="numberBooks" required><br>
                <label for="staffID">Staff ID (Required):</label><br>
                <select id="staffID" name="staffID" required></select><br>
                <label for="date">Date (Required):</label><br>
                <input type="date" id="date" name="date" required><br>
                <button type="button" onclick="addTransaction()">Submit</button>
            </fieldset>
        </form>

        <!-- Form to edit an existing transaction -->
        <form id="editTransactionForm">
            <fieldset>
                <legend>Edit Transaction</legend>
                <input type="hidden" id="editTransactionID">
                <label for="editPatronID">Patron ID (Required):</label><br>
                <select id="editPatronID" required></select><br>
                <label for="editNumberBooks">Number of Books (Required):</label><br>
                <input type="number" id="editNumberBooks" required><br>
                <label for="editStaffID">Staff ID (Required):</label><br>
                <select id="editStaffID" required></select><br>
                <label for="editDate">Date (Required):</label><br>
                <input type="date" id="editDate" required><br>
                <button type="button" onclick="updateTransaction()">Update</button>
            </fieldset>
        </form>
    </div>

    <!-- Additional display-only table for transaction details -->
    <h2>Transaction Details</h2>
    <div class="filter-container">
        <input type="text" id="detailsFilterInput" onkeyup="filterTable('transactionDetailsTable')" placeholder="Search for transaction details...">
    </div>
    <table id="transactionDetailsTable">
        <thead>
            <tr>
                <th>Transaction Details ID</th>
                <th>Transaction ID</th>
                <th>Book ID</th>
                <th>Date</th>
                <th>Due Date</th>
            </tr>
        </thead>
        <tbody>
            <!-- Dynamic content generated by JavaScript -->
        </tbody>
    </table>

    <script>
        // Initial data loading when document is ready
        document.addEventListener("DOMContentLoaded", function() {
            fetchTransactions();
            fetchTransactionDetails();
            fetchPatronIDs();
            fetchStaffIDs();
        });

        // Fetch and populate patron IDs for form selections
        function fetchPatronIDs() {
            fetch('http://read-renaissance.com/api/patrons')
                .then(response => response.json())
                .then(data => {
                    const patronSelect = document.getElementById('patronID');
                    const editPatronSelect = document.getElementById('editPatronID');
                    patronSelect.innerHTML = '';
                    editPatronSelect.innerHTML = '';
                    data.forEach(patron => {
                        const option = document.createElement('option');
                        option.value = patron.patronID;
                        option.text = `${patron.first_name} ${patron.last_name}`;
                        patronSelect.appendChild(option.cloneNode(true));
                        editPatronSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching patrons:', error));
        }

        // Fetch and populate staff IDs for form selections
        function fetchStaffIDs() {
            fetch('http://read-renaissance.com/api/staff')
                .then(response => response.json())
                .then(data => {
                    const staffSelect = document.getElementById('staffID');
                    const editStaffSelect = document.getElementById('editStaffID');
                    staffSelect.innerHTML = '';
                    editStaffSelect.innerHTML = '';
                    data.forEach(staff => {
                        const option = document.createElement('option');
                        option.value = staff.staffId;
                        option.text = `${staff.firstName} ${staff.lastName}`;
                        staffSelect.appendChild(option.cloneNode(true));
                        editStaffSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching staff IDs:', error));
        }

        // Fetch and display transactions in the table
        function fetchTransactions() {
            fetch('http://read-renaissance.com/api/transactions')
                .then(response => response.json())
                .then(data => populateTable(data, 'transactionsTable'))
                .catch(error => console.error('Error fetching transactions:', error));
        }

        // Populate transactions table with data
        function populateTable(data, tableID) {
            const tableBody = document.getElementById(tableID).getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            data.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${item.transactionID || item.transactionDetailsID}</td>
                    <td>${item.patronID || item.transactionID}</td>
                    <td>${item.numberBooks || item.bookID}</td>
                    <td>${item.staffID || item.date}</td>
                    <td>${item.date || item.dueDate}</td>
                    ${item.numberBooks ? `<td>
                        <button onclick="editTransaction(${item.transactionID}, ${item.patronID}, ${item.numberBooks}, ${item.staffID}, '${item.date}')">Edit</button>
                        <button onclick="deleteTransaction(${item.transactionID})">Delete</button>
                    </td>` : ''}
                `;
            });
        }

        // Fetch and display book transaction details
        function fetchTransactionDetails() {
            fetch('http://read-renaissance.com/api/bt_details')
                .then(response => response.json())
                .then(details => populateTable(details, 'transactionDetailsTable'))
                .catch(error => console.error('Error fetching transaction details:', error));
        }

        // Add a new transaction to the system
        function addTransaction() {
            const form = document.getElementById('addTransactionForm');
            const patronID = form.patronID.value.trim();
            const numberBooks = form.numberBooks.value.trim();
            const staffID = form.staffID.value.trim();
            const date = form.date.value.trim();

            if (!patronID || !numberBooks || !staffID || !date) {
                alert('All fields are required. Please fill out all fields.');
                return;
            }

            const formData = {
                patronID: parseInt(patronID, 10),
                numberBooks: parseInt(numberBooks, 10),
                staffID: parseInt(staffID, 10),
                date: date
            };

            fetch('http://read-renaissance.com/api/transactions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json().then(data => {
                        alert('Transaction added successfully!');
                        fetchTransactions();
                    });
                } else {
                    alert('Failed to add transaction. Please check your data and try again.');
                    throw new Error('Failed to add transaction.');
                }
            })
            .catch(error => console.error('Error adding transaction:', error));
        }

        // Load transaction data into the edit form
        function editTransaction(transactionID, patronID, numberBooks, staffId, date) {
            document.getElementById('editTransactionID').value = transactionID;
            document.getElementById('editPatronID').value = patronID;
            document.getElementById('editNumberBooks').value = numberBooks;
            document.getElementById('editStaffID').value = staffId;
            document.getElementById('editDate').value = date;
        }

        // Update an existing transaction
        function updateTransaction() {
            const transactionID = document.getElementById('editTransactionID').value;
            const patronID = document.getElementById('editPatronID').value.trim();
            const numberBooks = document.getElementById('editNumberBooks').value.trim();
            const staffID = document.getElementById('editStaffID').value.trim();
            const date = document.getElementById('editDate').value.trim();

            if (!patronID || !numberBooks || !staffID || !date) {
                alert('All fields are required. Please fill out all fields.');
                return;
            }

            const formData = {
                patronID: parseInt(patronID, 10),
                numberBooks: parseInt(numberBooks, 10),
                staffID: parseInt(staffID, 10),
                date: date
            };

            fetch(`http://read-renaissance.com/api/transactions/${transactionID}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json().then(data => {
                        alert('Transaction updated successfully!');
                        fetchTransactions();
                    });
                } else {
                    alert('Failed to update transaction. Please check your data and try again.');
                    throw new Error('Failed to update transaction.');
                }
            })
            .catch(error => console.error('Error updating transaction:', error));
        }

        // Delete a transaction from the system
        function deleteTransaction(transactionID) {
            fetch(`http://read-renaissance.com/api/transactions/${transactionID}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                alert('Transaction deleted successfully!');
                fetchTransactions();
            })
            .catch(error => console.error('Error deleting transaction:', error));
        }

        // Filter table based on search input
        function filterTable(tableID) {
            let input = document.getElementById("filterInput");
            let filter = input.value.toUpperCase();
            let table = document.getElementById(tableID);
            let tr = table.getElementsByTagName("tr");

            for (let i = 0; i < tr.length; i++) {
                let td = tr[i].getElementsByTagName("td");
                let visible = false;
                for (let j = 0; j < td.length; j++) {
                    if (td[j] && td[j].textContent.toUpperCase().indexOf(filter) > -1) {
                        visible = true;
                    }
                }
                tr[i].style.display = visible ? "" : "none";
            }
        }
    </script>
</body>
</html>
